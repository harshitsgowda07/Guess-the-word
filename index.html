<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess the Word</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tile {
            width: 60px;
            height: 60px;
            border: 2px solid #d1d5db;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        .tile.green { background-color: #10B981; color: white; border-color: #10B981; }
        .tile.orange { background-color: #F59E0B; color: white; border-color: #F59E0B; }
        .tile.grey { background-color: #6B7280; color: white; border-color: #6B7280; }
        .keyboard-btn {
            transition: background-color 0.2s ease;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 max-w-lg">

        <!-- Header -->
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold tracking-wider">GUESS THE WORD</h1>
        </header>

        <!-- Auth Section -->
        <section id="auth-section" class="bg-white p-6 rounded-lg shadow-md">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
                <input type="text" id="login-username" placeholder="Username" class="w-full p-2 mb-3 border rounded">
                <input type="password" id="login-password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
                <button id="login-btn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
                <p class="text-center mt-4">
                    Don't have an account? <a href="#" id="show-register" class="text-blue-500">Register</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Register</h2>
                <input type="text" id="register-username" placeholder="Username" class="w-full p-2 mb-3 border rounded">
                <p id="username-error" class="text-red-500 text-sm mb-2"></p>
                <input type="password" id="register-password" placeholder="Password" class="w-full p-2 mb-3 border rounded">
                <p id="password-error" class="text-red-500 text-sm mb-2"></p>
                <button id="register-btn" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Register</button>
                <p class="text-center mt-4">
                    Already have an account? <a href="#" id="show-login" class="text-blue-500">Login</a>
                </p>
            </div>
        </section>

        <!-- Game Section -->
        <section id="game-section" class="hidden text-center">
             <div class="flex justify-between items-center mb-4">
                <span id="user-greeting" class="font-semibold"></span>
                <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Logout</button>
            </div>
            <div id="game-board" class="grid grid-rows-5 gap-2 my-4 mx-auto" style="width: 330px;">
                <!-- Rows will be generated by JS -->
            </div>
             <p id="game-message" class="my-4 text-lg font-medium"></p>
             <button id="start-game-btn" class="bg-indigo-500 text-white px-6 py-2 rounded-lg hover:bg-indigo-600">Start New Game</button>
             <div id="admin-controls" class="hidden mt-6">
                <button id="show-reports-btn" class="bg-gray-700 text-white px-6 py-2 rounded-lg hover:bg-gray-800">View Reports</button>
            </div>
        </section>

        <!-- Admin Reports Section -->
        <section id="admin-section" class="hidden bg-white p-6 rounded-lg shadow-md mt-6">
            <h2 class="text-2xl font-semibold mb-4 text-center">Admin Reports</h2>
            <div class="mb-4">
                <label for="report-date" class="block mb-2">Select Date for Daily Report:</label>
                <input type="date" id="report-date" class="w-full p-2 border rounded">
                <button id="generate-daily-report-btn" class="w-full mt-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Generate Daily Report</button>
            </div>
            <div id="daily-report-results" class="mt-4 p-4 border rounded bg-gray-50"></div>

            <div class="mt-6">
                <label for="report-user" class="block mb-2">Select User for User Report:</label>
                <select id="report-user" class="w-full p-2 border rounded"></select>
                <button id="generate-user-report-btn" class="w-full mt-2 bg-green-500 text-white p-2 rounded hover:bg-green-600">Generate User Report</button>
            </div>
            <div id="user-report-results" class="mt-4 p-4 border rounded bg-gray-50"></div>
             <button id="back-to-game-btn" class="w-full mt-6 bg-gray-500 text-white p-2 rounded hover:bg-gray-600">Back to Game</button>
        </section>

        <!-- Custom Modal -->
        <div id="custom-modal" class="modal">
            <div class="modal-content">
                <p id="modal-message" class="text-lg mb-4"></p>
                <button id="modal-ok-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your Firebase project's configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBsWXYoJH3O1-gJX-V_u65GiP28332R1jE",
  authDomain: "guess-the-word-68d8e.firebaseapp.com",
  projectId: "guess-the-word-68d8e",
  storageBucket: "guess-the-word-68d8e.firebasestorage.app",
  messagingSenderId: "308534582099",
  appId: "1:308534582099:web:813f689fec80f8b5d55fa6",
  measurementId: "G-Z354CEYPFY"
};
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const gameSection = document.getElementById('game-section');
        const adminSection = document.getElementById('admin-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const gameBoard = document.getElementById('game-board');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameMessage = document.getElementById('game-message');
        const userGreeting = document.getElementById('user-greeting');
        const logoutBtn = document.getElementById('logout-btn');
        const adminControls = document.getElementById('admin-controls');
        const showReportsBtn = document.getElementById('show-reports-btn');
        const backToGameBtn = document.getElementById('back-to-game-btn');

        // Modal elements
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        // Report elements
        const reportDate = document.getElementById('report-date');
        const generateDailyReportBtn = document.getElementById('generate-daily-report-btn');
        const dailyReportResults = document.getElementById('daily-report-results');
        const reportUser = document.getElementById('report-user');
        const generateUserReportBtn = document.getElementById('generate-user-report-btn');
        const userReportResults = document.getElementById('user-report-results');


        // --- State ---
        let currentUser = null;
        let targetWord = '';
        let currentGuess = '';
        let guessCount = 0;
        let gameActive = false;
        let gameId = null;

        const MAX_GUESSES = 5;
        const WORD_LENGTH = 5;

        // --- App Initialization ---
        
        // Setup initial words in DB (run once)
        async function seedDatabase() {
            const initialWords = ["APPLE", "BEACH", "BRAIN", "BREAD", "CHAIR", "DREAM", "EARTH", "FIGHT", "GRAPE", "HEART", "HOUSE", "LIGHT", "MONEY", "MUSIC", "PLANT", "POWER", "SMILE", "SPACE", "WATER", "WORLD"];
            const wordsCollection = collection(db, "words");
            const snapshot = await getDocs(wordsCollection);
            if (snapshot.empty) {
                console.log("Seeding database with initial words...");
                for (const word of initialWords) {
                    await addDoc(wordsCollection, { value: word });
                }
            } else {
                console.log("Database already seeded.");
            }
        }
        seedDatabase();

        // --- Auth State Change ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                
                const username = userData.username || user.email.split('@')[0];
                userGreeting.textContent = `Welcome, ${username}!`;
                
                authSection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                adminSection.classList.add('hidden');

                if (userData.isAdmin) {
                    adminControls.classList.remove('hidden');
                } else {
                    adminControls.classList.add('hidden');
                }
                
                resetGameState();
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                gameSection.classList.add('hidden');
                adminSection.classList.add('hidden');
            }
        });

        // --- Event Listeners ---
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });
        
        // --- Registration ---
        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const usernameError = document.getElementById('username-error');
            const passwordError = document.getElementById('password-error');

            // Reset errors
            usernameError.textContent = '';
            passwordError.textContent = '';

            // Validation
            let isValid = true;
            if (!/^[a-zA-Z]{5,}$/.test(username)) {
                usernameError.textContent = 'Username must be at least 5 letters (a-z, A-Z).';
                isValid = false;
            }
            if (!/^(?=.*[a-zA-Z])(?=.*\d)(?=.*[$%*@]).{5,}$/.test(password)) {
                passwordError.textContent = 'Password must be 5+ chars with alpha, numeric, and one of $, %, *, @.';
                isValid = false;
            }

            if (!isValid) return;

            try {
                // Use a dummy email for Firebase Auth, as it requires it. We'll use username for our app logic.
                const userCredential = await createUserWithEmailAndPassword(auth, `${username}@example.com`, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    username: username,
                    isAdmin: false // Default to not admin
                });
                console.log('User registered');
            } catch (error) {
                showModal(`Error: ${error.message}`);
            }
        });
        
        // --- Login ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, `${username}@example.com`, password);
                console.log('User logged in');
            } catch (error) {
                showModal('Invalid username or password.');
            }
        });

        // --- Logout ---
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // --- Game Logic ---
        startGameBtn.addEventListener('click', async () => {
            if (!currentUser) return;
        
            // Check daily limit
            const today = new Date().toISOString().split('T')[0];
            const gamesCol = collection(db, "games");
            const q = query(gamesCol, where("userId", "==", currentUser.uid), where("date", "==", today));
            const gamesTodaySnapshot = await getDocs(q);
        
            if (gamesTodaySnapshot.size >= 3) {
                showModal("You have already played 3 games today. Come back tomorrow!");
                return;
            }
        
            resetGameState();
            gameActive = true;
            startGameBtn.disabled = true;
            gameMessage.textContent = 'Guess the 5-letter word.';
        
            // Fetch a random word
            const wordsCollection = collection(db, "words");
            const wordsSnapshot = await getDocs(wordsCollection);
            const words = wordsSnapshot.docs.map(doc => doc.data().value);
            targetWord = words[Math.floor(Math.random() * words.length)];
            console.log("Target Word:", targetWord); // For debugging
            
            // Create a new game document
            const newGameRef = await addDoc(collection(db, "games"), {
                userId: currentUser.uid,
                word: targetWord,
                guesses: [],
                correct: false,
                timestamp: Timestamp.now(),
                date: today
            });
            gameId = newGameRef.id;
        });

        function resetGameState() {
            gameBoard.innerHTML = '';
            for (let i = 0; i < MAX_GUESSES; i++) {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-5 gap-2';
                for (let j = 0; j < WORD_LENGTH; j++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    row.appendChild(tile);
                }
                gameBoard.appendChild(row);
            }
            guessCount = 0;
            currentGuess = '';
            gameActive = false;
            targetWord = '';
            gameId = null;
            startGameBtn.disabled = false;
            gameMessage.textContent = '';
        }

        async function submitGuess() {
            if (!gameActive || currentGuess.length !== WORD_LENGTH) return;
            
            // Save guess to DB
            const gameRef = doc(db, "games", gameId);
            const gameDoc = await getDoc(gameRef);
            const gameData = gameDoc.data();
            const updatedGuesses = [...gameData.guesses, currentGuess];
            await setDoc(gameRef, { guesses: updatedGuesses }, { merge: true });

            const row = gameBoard.children[guessCount];
            const tiles = row.children;
            const targetLetters = targetWord.split('');
            const guessLetters = currentGuess.split('');

            // Green pass
            for (let i = 0; i < WORD_LENGTH; i++) {
                tiles[i].textContent = guessLetters[i];
                if (guessLetters[i] === targetLetters[i]) {
                    tiles[i].classList.add('green');
                    targetLetters[i] = null; // Mark as used
                }
            }

            // Orange pass
            for (let i = 0; i < WORD_LENGTH; i++) {
                if (!tiles[i].classList.contains('green')) {
                    const letterIndex = targetLetters.indexOf(guessLetters[i]);
                    if (letterIndex > -1) {
                        tiles[i].classList.add('orange');
                        targetLetters[letterIndex] = null; // Mark as used
                    } else {
                        tiles[i].classList.add('grey');
                    }
                }
            }

            guessCount++;
            
            if (currentGuess === targetWord) {
                gameActive = false;
                await setDoc(gameRef, { correct: true }, { merge: true });
                setTimeout(() => showModal("Congratulations! You guessed the word!"), 500);
                startGameBtn.disabled = false;
            } else if (guessCount === MAX_GUESSES) {
                gameActive = false;
                setTimeout(() => showModal(`Better luck next time! The word was ${targetWord}.`), 500);
                startGameBtn.disabled = false;
            }
            
            currentGuess = '';
        }

        // Keyboard input
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;

            if (e.key === 'Enter') {
                submitGuess();
            } else if (e.key === 'Backspace') {
                currentGuess = currentGuess.slice(0, -1);
            } else if (/^[a-zA-Z]$/.test(e.key) && currentGuess.length < WORD_LENGTH) {
                currentGuess += e.key.toUpperCase();
            }
            updateCurrentRow();
        });

        function updateCurrentRow() {
            if (!gameActive || guessCount >= MAX_GUESSES) return;
            const row = gameBoard.children[guessCount];
            const tiles = row.children;
            for (let i = 0; i < WORD_LENGTH; i++) {
                tiles[i].textContent = currentGuess[i] || '';
            }
        }
        
        // --- Modal Logic ---
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.style.display = 'block';
        }

        modalOkBtn.addEventListener('click', () => {
            customModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == customModal) {
                customModal.style.display = 'none';
            }
        });
        
        // --- Admin/Reports Logic ---
        showReportsBtn.addEventListener('click', async () => {
            gameSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            await populateUserDropdown();
        });

        backToGameBtn.addEventListener('click', () => {
            adminSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
        });

        async function populateUserDropdown() {
            reportUser.innerHTML = '<option value="">Select a user</option>';
            const usersSnapshot = await getDocs(collection(db, "users"));
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (!user.isAdmin) {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = user.username;
                    reportUser.appendChild(option);
                }
            });
        }
        
        generateDailyReportBtn.addEventListener('click', async () => {
            const date = reportDate.value; // YYYY-MM-DD format
            if (!date) {
                dailyReportResults.innerHTML = '<p class="text-red-500">Please select a date.</p>';
                return;
            }

            const gamesCol = collection(db, "games");
            const q = query(gamesCol, where("date", "==", date));
            const snapshot = await getDocs(q);

            let userSet = new Set();
            let correctGuesses = 0;

            snapshot.forEach(doc => {
                const game = doc.data();
                userSet.add(game.userId);
                if (game.correct) {
                    correctGuesses++;
                }
            });

            dailyReportResults.innerHTML = `
                <h3 class="font-semibold text-lg">Report for ${date}</h3>
                <p>Total Users Played: ${userSet.size}</p>
                <p>Total Correct Guesses: ${correctGuesses}</p>
            `;
        });
        
        generateUserReportBtn.addEventListener('click', async () => {
            const userId = reportUser.value;
            if (!userId) {
                userReportResults.innerHTML = '<p class="text-red-500">Please select a user.</p>';
                return;
            }

            const gamesCol = collection(db, "games");
            const q = query(gamesCol, where("userId", "==", userId));
            const snapshot = await getDocs(q);

            const gamesByDate = {};

            snapshot.forEach(doc => {
                const game = doc.data();
                const date = game.date;
                if (!gamesByDate[date]) {
                    gamesByDate[date] = { tried: 0, correct: 0 };
                }
                gamesByDate[date].tried++;
                if (game.correct) {
                    gamesByDate[date].correct++;
                }
            });

            let reportHtml = `<h3 class="font-semibold text-lg">Report for ${reportUser.options[reportUser.selectedIndex].text}</h3>`;
            if (Object.keys(gamesByDate).length === 0) {
                 reportHtml += '<p>No games played by this user.</p>';
            } else {
                for (const date in gamesByDate) {
                    reportHtml += `
                        <div class="mt-2 p-2 border-t">
                            <p><strong>Date:</strong> ${date}</p>
                            <p>Words Tried: ${gamesByDate[date].tried}</p>
                            <p>Correct Guesses: ${gamesByDate[date].correct}</p>
                        </div>
                    `;
                }
            }
            userReportResults.innerHTML = reportHtml;
        });

    </script>
</body>
</html>

